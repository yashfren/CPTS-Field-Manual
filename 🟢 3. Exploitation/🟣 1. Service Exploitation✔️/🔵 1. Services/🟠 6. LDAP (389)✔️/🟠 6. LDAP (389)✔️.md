## LDAP – Discovery, Enumeration, and Injection
### 1. What is LDAP?

LDAP (Lightweight Directory Access Protocol) is a protocol used to access and manage data stored in a directory service. Directory services are hierarchical databases storing user, group, device, and policy information.
### 2. Functionality and Benefits

| Feature           | Description                                                                 |
| ----------------- | --------------------------------------------------------------------------- |
| Efficient         | Fast queries and responses with lean query language and flat data structure |
| Global Naming     | Unique entries in multiple directories via a global naming model            |
| Extensible Schema | Custom attributes and object classes supported                              |
| Cross-Platform    | TCP/IP and SSL based, compatible with various OS and applications           |
| Authentication    | Single sign-on, central credential management                               |
### 3. Common Use Cases

| Use Case           | Description                                                           |
| ------------------ | --------------------------------------------------------------------- |
| Authentication     | LDAP is used for central user authentication across multiple services |
| Authorisation      | Controls access to network resources (integrates with Kerberos/NTLM)  |
| Directory Services | Search, retrieve, and modify user and system data                     |
| Synchronisation    | Keeps user/account data consistent across services                    |
### 4. Implementations: LDAP vs Active Directory

| LDAP                  | Active Directory (AD)                                          |
| --------------------- | -------------------------------------------------------------- |
| Open protocol         | Microsoft’s proprietary implementation of a directory service  |
| Cross-platform        | Windows-centric                                                |
| Extensible schema     | Schema based on X.500, extensible with care                    |
| Uses simple bind/SASL | Uses Kerberos (main), also supports LDAP over SSL/TLS and NTLM |
| Protocol-only         | Full-featured directory service with policy, SSO, GPOs, etc.   |
### 5. LDAP Protocol Details

Architecture: Client-server  
Transport: TCP/UDP over port 389 (LDAP) or 636 (LDAPS)  
Message Encoding: ASN.1 over TCP/IP  
Core Operations:

- `Bind`: Authenticate client    
- `Search`: Query data
- `Compare`: Match attributes
- `Add/Delete/Modify`: CRUD operations
- `Unbind`: Close connection
### 6. Practical Tool: `ldapsearch`

Example:

```bash
ldapsearch -H ldap://ldap.example.com:389 \
  -D "cn=admin,dc=example,dc=com" -w secret123 \
  -b "ou=people,dc=example,dc=com" "(mail=john.doe@example.com)"
```

Breakdown:

- `-H`: Server + port    
- `-D`: Bind DN (Distinguished Name)
- `-w`: Password
- `-b`: Base search DN
- Final argument is the search filter (RFC4515 syntax)

Expected output:

```
dn: uid=jdoe,ou=people,dc=example,dc=com
objectClass: inetOrgPerson
cn: John Doe
sn: Doe
uid: jdoe
mail: john.doe@example.com
```
### 7. LDAP Injection

LDAP Injection occurs when unsanitised user input is incorporated into LDAP queries, enabling attackers to manipulate authentication or data lookup.
#### Input Manipulation Examples:

| Character | Effect                      |
| --------- | --------------------------- |
| `*`       | Wildcard for any characters |
| `()`      | Group expressions           |
| `         | `                           |
| `&`       | Logical AND                 |
#### Injection Scenario – Authentication Bypass

Original query:

```php
(&(objectClass=user)(sAMAccountName=$username)(userPassword=$password))
```

Bypass using:

```php
$username = "*";
$password = "*";
```

New query:

```php
(&(objectClass=user)(sAMAccountName=*)(userPassword=*))
```

This matches any user with any password, granting unauthorised access.
### 8. Impact of LDAP Injection

- Bypass authentication    
- View or modify sensitive directory data
- Escalate privileges
- Deny access by altering directory entries
### 9. Mitigation Techniques

- Sanitize user inputs    
- Disallow special LDAP characters: `*`, `(`, `)`, `|`, `&`, etc.
- Use parameterised queries or safe libraries
- Enforce input validation and encoding
- Employ least privilege principle for LDAP bind accounts
### 10. Enumeration and Port Discovery

```bash
nmap -p- -sC -sV --open --min-rate=1000 10.129.204.229
```

Sample Output:

```
PORT    STATE SERVICE VERSION
80/tcp  open  http    Apache httpd 2.4.41 ((Ubuntu))
389/tcp open  ldap    OpenLDAP 2.2.X - 2.3.X
```

- Confirms web interface on port 80
- Confirms OpenLDAP directory on port 389
### 11. Exploit: Wildcard Authentication Bypass

- Application uses OpenLDAP for login.    
- Injecting `*` in both username and password fields logs in without valid credentials.

Implication: Complete compromise of authentication mechanism via unauthenticated LDAP injection.
# Tags
> #Exploitation #Service-Exploitation #LDAP