# NTFS (New Technology File System) – Windows Internals

NTFS is the default file system for Windows. It supports advanced features like file permissions, compression, encryption, and journaling. Understanding how NTFS works is crucial for **post-exploitation**, **privilege escalation**, and **lateral movement**.
## 1. NTFS Features (Security-Relevant)

|Feature|Description|
|---|---|
|**File Permissions**|Uses DACLs to control access to files and folders.|
|**Alternate Data Streams (ADS)**|Hides data inside existing files (e.g., `file.txt:hidden.txt`).|
|**Hard Links / Junctions**|Can redirect access to other files/folders for evasion or exploitation.|
|**NTFS Compression**|Reduces file size; not security-relevant, but detectable.|
|**NTFS Encryption (EFS)**|User-based file encryption; can hinder or aid post-exploitation.|
|**Transactional NTFS (TxF)**|Abused in some persistence techniques; not commonly used.|
## 2. NTFS Permissions & ACLs

### Standard Permissions

|Permission|Description|
|---|---|
|Full Control|All actions including delete|
|Modify|Read, write, and delete|
|Read & Execute|View and execute|
|List Folder Contents|List files inside a directory|
|Read|View content|
|Write|Modify/add content|
### Special Permissions

- `TakeOwnership`    
- `ChangePermissions`
- `Delete`
- `CreateFiles`, `AppendData`

> **ACLs** can be abused for **privilege escalation** if misconfigured (e.g., `Everyone:F`).
## 3. Enumeration of NTFS Permissions

### PowerShell

```powershell
Get-Acl <file/folder> | Format-List
```
###  icacls

```cmd
icacls C:\path\to\folder
```
###  AccessChk (Sysinternals)

```cmd
accesschk.exe -dqvw user C:\path
```
## 4. Alternate Data Streams (ADS)
### ▶ What is ADS?

NTFS allows files to contain more than one data stream.

```cmd
echo hidden > normal.txt:hidden.txt
more < normal.txt:hidden.txt
```

Can be used to hide payloads or persistence artifacts.
### ▶ Detecting ADS

```cmd
dir /R
```

Or use `streams.exe` from Sysinternals:

```cmd
streams.exe C:\folder
```
## 5. Hard Links & Junction Abuse
### ▶ Junctions

Symbolic links to directories; used to redirect execution or access.

```cmd
mklink /J linkName targetDir
```
### ▶ Abuse

- Replace service paths    
- Bypass file write restrictions

> Tools: [CreateSymlink](https://github.com/googleprojectzero/symboliclink-testing-tools), [Juicy Potato], [GenericPotato]
## 6. Forensics & Persistence via NTFS

| Vector             | Description                            |
| ------------------ | -------------------------------------- |
| ADS                | Hide malware/payloads                  |
| Symlinks/Junctions | Redirect write paths or execution      |
| Misconfigured ACLs | Escalate privileges                    |
| NTFS Time Stomping | Modify file timestamps to hide changes |
## 7. NTFS in Privilege Escalation

Misconfigurations that can be abused:

- Folders where `Users` or `Everyone` has **Write** or **FullControl**
- Replace service binaries 
- Add startup scripts
- Inject malicious DLLs in writable directories
