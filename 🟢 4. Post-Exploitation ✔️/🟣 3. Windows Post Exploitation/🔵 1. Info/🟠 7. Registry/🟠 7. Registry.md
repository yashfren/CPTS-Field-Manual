# Windows Registry – Post-Exploitation Overview

The **Windows Registry** is a hierarchical database that stores low-level settings for the OS, services, applications, and user configurations. Post-exploitation, registry analysis allows us to **extract credentials**, **configure persistence**, and **discover valuable system info**.
## 1. Registry Architecture

The registry consists of multiple **hives**:

|Hive|Path|Description|
|---|---|---|
|`HKEY_LOCAL_MACHINE`|`HKLM`|System-wide settings and driver config|
|`HKEY_CURRENT_USER`|`HKCU`|Logged-in user settings|
|`HKEY_USERS`||All user profiles|
|`HKEY_CLASSES_ROOT`||File association and COM information|
|`HKEY_CURRENT_CONFIG`||Dynamic hardware configuration|

Each hive is backed by a physical file on disk:

- `HKLM\SAM` → `%SystemRoot%\System32\Config\SAM`    
- `HKLM\SYSTEM` → `%SystemRoot%\System32\Config\SYSTEM`
- `HKCU` → `C:\Users\<User>\NTUSER.DAT`
## 2. Useful Commands for Enumeration

### Query a Specific Key

```powershell
Get-Item -Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run"
```

```cmd
reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Run
```
### List All Subkeys and Values

```powershell
Get-ChildItem -Path "HKLM:\Software" -Recurse
```

```cmd
reg query HKLM /s
```
## 3. Post-Exploitation Use Cases

|Goal|Registry Path / Method|
|---|---|
|**Persistence**|`HKLM\Software\Microsoft\Windows\CurrentVersion\Run`|
||`HKCU\Software\Microsoft\Windows\CurrentVersion\Run`|
||`HKLM\SYSTEM\CurrentControlSet\Services\<ServiceName>` (Service creation)|
|**Password Hunting**|`HKLM\Security\Policy\Secrets` (SAM/LSA secrets)|
||Look in third-party app keys for stored creds|
|**UAC Bypass**|`HKCU\Software\Classes\mscfile\shell\open\command`|
||`HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System`|
|**Autoruns Discovery**|`HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce`|
||`HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Run`|
|**Identify Installed SW**|`HKLM\Software\Microsoft\Windows\CurrentVersion\Uninstall`|
|**Privilege Escalation**|Insecure permissions on autorun keys or service keys|
## 4. Registry as a Payload Container

Malware and offensive tools can store payloads in registry keys to **evade AV detection**.

Example (storing a base64 payload):

```powershell
Set-ItemProperty -Path "HKCU:\Software\Microsoft" -Name "payload" -Value "base64-blob"
```

Then read and execute later.
## 5. Tools

- `reg` (built-in)    
- `regedit.exe` (GUI)
- `PowerView`
- `Autoruns.exe` (Sysinternals)
- `WinPEAS` / `Seatbelt` (automated enum)
## 6. Registry Permissions & Abuse

Attackers can exploit **misconfigured ACLs** in the registry to escalate privileges or gain persistence.

Check permissions:

```powershell
Get-Acl -Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run" | Format-List
```

Look for **non-admin users with `Write` or `FullControl`**.
